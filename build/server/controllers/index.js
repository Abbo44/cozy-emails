// Generated by CoffeeScript 1.7.1
var Account, CozyInstance, ImapReporter, Promise, Settings, fixtures;

CozyInstance = require('../models/cozy_instance');

Account = require('../models/account');

Settings = require('../models/settings');

Promise = require('bluebird');

ImapReporter = require('../processes/imap_reporter');

fixtures = require('cozy-fixtures');

module.exports.main = function(req, res, next) {
  return Promise.all([
    Settings.getInstance(), CozyInstance.getLocalePromised()["catch"](function(err) {
      return 'en';
    }), Account.requestPromised('all').map(function(account) {
      return account.toObjectWithMailbox();
    }), ImapReporter.summary()
  ]).spread(function(settings, locale, accounts, tasks) {
    return "window.settings = " + (JSON.stringify(settings)) + "\nwindow.tasks = " + (JSON.stringify(tasks)) + ";\nwindow.locale = \"" + locale + "\";\nwindow.accounts = " + (JSON.stringify(accounts)) + ";";
  })["catch"](function(err) {
    console.log(err.stack);
    return "console.log(\"" + err + "\");\nwindow.locale = \"en\"\nwindow.tasks = []\nwindow.accounts = []";
  }).then(function(imports) {
    return res.render('index.jade', {
      imports: imports
    });
  });
};

module.exports.loadFixtures = function(req, res, next) {
  return fixtures.load({
    silent: true,
    callback: function(err) {
      if (err != null) {
        return next(err);
      } else {
        return res.send(200, {
          message: 'LOAD FIXTURES SUCCESS'
        });
      }
    }
  });
};

module.exports.refresh = function(req, res, next) {
  return Account.refreshAllAccounts().then(function() {
    return res.send(200, {
      refresh: 'done'
    });
  })["catch"](next);
};

module.exports.tasks = function(req, res, next) {
  return res.send(200, ImapReporter.summary());
};
