// Generated by CoffeeScript 1.8.0
var Account, CozyInstance, async, fixtures;

async = require('async');

Account = require('../models/account');

CozyInstance = require('../models/cozy_instance');

fixtures = require('cozy-fixtures');

module.exports.main = function(req, res, next) {
  return async.parallel([
    function(cb) {
      return CozyInstance.getLocale(cb);
    }, function(cb) {
      return Account.getAll(cb);
    }
  ], function(err, results) {
    var accounts, locale;
    if (err != null) {
      console.log(err);
      return res.render('index.jade', {
        imports: "console.log(\"" + err + "\")\nwindow.locale = \"en\";\nwindow.accounts = {};"
      });
    } else {
      locale = results[0], accounts = results[1];
      accounts = accounts.map(Account.clientVersion);
      return res.render('index.jade', {
        imports: "window.locale = \"" + locale + "\";\nwindow.accounts = " + (JSON.stringify(accounts)) + ";"
      });
    }
  });
};

module.exports.loadFixtures = function(req, res, next) {
  return fixtures.load({
    silent: true,
    callback: function(err) {
      if (err != null) {
        return next(err);
      } else {
        return res.send(200, {
          message: 'LOAD FIXTURES SUCCESS'
        });
      }
    }
  });
};
