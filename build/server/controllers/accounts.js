// Generated by CoffeeScript 1.7.1
var Account, AccountConfigError, HttpError, Imap, Mailbox, async, log, _, _ref;

async = require('async');

Account = require('../models/account');

Mailbox = require('../models/mailbox');

Imap = require('../processes/imap_processes');

_ = require('lodash');

_ref = require('../utils/errors'), AccountConfigError = _ref.AccountConfigError, HttpError = _ref.HttpError;

log = require('../utils/logging')({
  prefix: 'accounts:controller'
});

module.exports.create = function(req, res, next) {
  var data;
  data = req.body;
  return Account.createIfValid(data).then(function(account) {
    return res.send(201, account);
  })["catch"](AccountConfigError, function(err) {
    log.warn(err.toString());
    log.warn(err.stack.split("\n")[2]);
    return res.send(400, {
      name: err.name,
      field: err.field,
      stack: err.stack,
      error: true
    });
  })["catch"](next);
};

module.exports.fetch = function(req, res, next) {
  return Account.findPromised(req.params.accountID).then(function(account) {
    if (account) {
      return req.account = account;
    } else {
      throw new HttpError(404, 'Not Found');
    }
  }).nodeify(next);
};

module.exports.list = function(req, res, next) {
  return Account.requestPromised('all').map(function(account) {
    return account.includeMailboxes();
  }).then(function(accounts) {
    return res.send(200, accounts);
  })["catch"](next);
};

module.exports.details = function(req, res, next) {
  return req.account.includeMailboxes().then(function() {
    return res.send(200, req.account);
  })["catch"](next);
};

module.exports.edit = function(req, res, next) {
  var changes;
  changes = _.pick(req.body, 'label', 'login', 'password', 'name', 'smtpServer', 'smtpPort', 'imapServer', 'imapPort', 'draftMailbox', 'sentMailbox', 'trashMailbox');
  return req.account.updateAttributesPromised(changes).then(function(account) {
    return account.includeMailboxes();
  }).then(function(account) {
    return res.send(200, req.account);
  })["catch"](next);
};

module.exports.remove = function(req, res, next) {
  return req.account.destroyEverything().then(function() {
    return res.send(204);
  })["catch"](next);
};
