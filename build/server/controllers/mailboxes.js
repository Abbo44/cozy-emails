// Generated by CoffeeScript 1.7.1
var Account, BadRequest, Mailbox, NotFound, Promise, async, log, _ref;

async = require('async');

Account = require('../models/account');

Mailbox = require('../models/mailbox');

Promise = require('bluebird');

_ref = require('../utils/errors'), BadRequest = _ref.BadRequest, NotFound = _ref.NotFound;

log = require('../utils/logging')({
  prefix: 'mailbox:controller'
});

module.exports.create = function(req, res, next) {
  var pAccount, pParent;
  log.info(("Creating " + req.body.label + " under " + req.body.parentID) + (" in " + req.body.accountID));
  pAccount = Account.findPromised(req.body.accountID);
  pParent = req.body.parentID ? Mailbox.findPromised(req.body.parentID) : Promise.resolve(null);
  return Promise.join(pAccount, pParent, function(account, parent) {
    var mailbox, path, tree;
    if (parent) {
      path = parent.path + parent.delimiter + req.body.label;
      tree = parent.tree.concat(req.body.label);
    } else {
      path = req.body.label;
      tree = [req.body.label];
    }
    mailbox = {
      accountID: account.id,
      label: req.body.label,
      path: path,
      tree: tree,
      delimiter: (parent != null ? parent.delimiter : void 0) || '/',
      attribs: []
    };
    return account.imap_createBox(path).then(function() {
      return Mailbox.createPromised(mailbox);
    })["return"](account);
  }).then(function(account) {
    return account.toObjectWithMailbox();
  }).then(function(account) {
    return res.send(account);
  })["catch"](next);
};

module.exports.update = function(req, res, next) {
  var pAccount, pBox;
  log.info("Updating " + req.params.mailboxID + " to " + req.body.label);
  pBox = Mailbox.findPromised(req.params.mailboxID).throwIfNull(function() {
    return new NotFound("Mailbox " + req.params.mailboxID);
  });
  pAccount = pBox.then(function(box) {
    return Account.findPromised(box.accountID);
  });
  return Promise.join(pBox, pAccount, function(box, account) {
    var favorites, newPath, parentPath, path;
    if (req.body.label) {
      path = box.path;
      parentPath = path.substring(0, path.lastIndexOf(box.label));
      newPath = parentPath + req.body.label;
      return account.imap_renameBox(path, newPath).then(function() {
        return box.renameWithChildren(newPath, req.body.label);
      })["return"](account);
    } else if (req.body.favorite != null) {
      favorites = _.without(account.favorites, box.id);
      if (req.body.favorite) {
        favorites.push(box.id);
      }
      account.favorites = favorites;
      return account.savePromised();
    } else {
      throw new BadRequest('Unsuported request for mailbox update');
    }
  }).then(function(account) {
    return account.toObjectWithMailbox();
  }).then(function(account) {
    return res.send(account);
  })["catch"](next);
};

module.exports["delete"] = function(req, res, next) {
  var pAccount, pBox;
  log.info("Deleting " + req.params.mailboxID);
  pBox = Mailbox.findPromised(req.params.mailboxID).throwIfNull(function() {
    return new NotFound("Mailbox " + req.params.mailboxID);
  });
  pAccount = pBox.then(function(box) {
    return Account.findPromised(box.accountID);
  });
  return Promise.join(pBox, pAccount, function(box, account) {
    return account.imap_deleteBox(box.path).then(function() {
      return account.forgetBox(box.id);
    }).then(function() {
      return box.destroyAndRemoveAllMessages();
    })["return"](account);
  }).then(function(account) {
    return account.toObjectWithMailbox();
  }).then(function(account) {
    return res.send(account);
  })["catch"](next);
};
